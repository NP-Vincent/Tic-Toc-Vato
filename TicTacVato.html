<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ•¶ï¸ Tic Tac Vato â€” Minimal</title>
  <style>
    body { font-family: 'Courier New', monospace; max-width: 420px; margin: 0 auto; padding: 20px; background: #121212; color: #f0f0f0; }
    h1 { color: #FF6B00; text-align: center; font-size: 2.2rem; margin: 6px 0 2px; text-shadow: 2px 2px 4px #000; }
    .subtitle { text-align: center; color: #aaa; margin-bottom: 18px; }
    #board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 18px 0; background: #1E1E1E; padding: 10px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,.5); }
    .cell { aspect-ratio: 1; background: #2A2A2A; border: 2px solid #FF6B00; display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; transition: all .2s; }
    .cell:hover { background: #333; transform: scale(1.04); }
    .cell.x { color: #4CAF50; } .cell.o { color: #F44336; }
    #status { font-weight: bold; margin: 12px 0; text-align: center; min-height: 40px; }
    .panel { background: #1E1E1E; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #FF6B00; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    button { background: linear-gradient(135deg, #FF6B00 0%, #FF9500 100%); color: #fff; border: 0; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%; transition: transform .1s, box-shadow .1s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(255,107,0,.35); }
    button:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
    #leaderboard ol { padding-left: 20px; margin: 8px 0 0; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color: #bbb; }
  </style>
</head>
<body>
  <h1>TIC TAC VATO</h1>
  <div class="subtitle">Outsmart the AI or lose your crypto</div>

  <div class="panel" id="economy">
    <div class="row"><div>ğŸ¦ Prize Pool</div><div><strong><span id="poolEth">0.001000</span> ETH</strong></div></div>
    <div class="row"><div>ğŸŸ Entry Fee (1%)</div><div><strong><span id="feeEth">0.000010</span> ETH</strong></div></div>
    <div class="row"><div>ğŸ“ˆ Target</div><div><strong>0.100000 ETH</strong></div></div>
    <small class="mono">50% fee â†’ house, 50% â†’ pool. At 0.1 ETH, top 3 spenders get 40/30/20% (demo only; real payouts require a backend or contract).</small>
  </div>

  <div class="row"><button id="connect">ğŸ”“ Connect Wallet</button></div>
  <div class="row"><button id="play" disabled>ğŸ’¸ Pay & Play</button></div>

  <div id="board" style="display:none;">
    <div class="cell" data-index="0"></div>
    <div class="cell" data-index="1"></div>
    <div class="cell" data-index="2"></div>
    <div class="cell" data-index="3"></div>
    <div class="cell" data-index="4"></div>
    <div class="cell" data-index="5"></div>
    <div class="cell" data-index="6"></div>
    <div class="cell" data-index="7"></div>
    <div class="cell" data-index="8"></div>
  </div>

  <div id="status">ğŸ‘‰ Connect wallet to challenge the vato</div>

  <div class="panel" id="leaderboard">
    <div class="row"><div>ğŸ† Top Spenders (demo)</div><div><button id="resetLb" style="width:auto;">Reset</button></div></div>
    <ol id="lbList"><li>â€”</li><li>â€”</li><li>â€”</li></ol>
  </div>

  <!-- Mini App SDK via ESM CDN, as suggested by the guide -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';

    // Display the app (hide host splash) once ready â€” critical per guide
    await sdk.actions.ready();  // If omitted, youâ€™ll see an infinite loader. :contentReference[oaicite:1]{index=1}

    // Get EIP-1193 provider from the Mini App SDK (no ethers)
    const provider = await sdk.wallet.getEthereumProvider(); // EVM-only app here. :contentReference[oaicite:2]{index=2}

    // Enforce Arbitrum One (42161)
    const ARBITRUM_HEX = '0xa4b1';
    let chainId = await provider.request({ method: 'eth_chainId' });
    if (chainId !== ARBITRUM_HEX) {
      try {
        await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: ARBITRUM_HEX }] });
        chainId = ARBITRUM_HEX;
      } catch (e) {
        document.getElementById('status').textContent = 'Please switch to Arbitrum One (42161).';
        throw e;
      }
    }

    // Elements
    const els = {
      poolEth: document.getElementById('poolEth'),
      feeEth: document.getElementById('feeEth'),
      connect: document.getElementById('connect'),
      play: document.getElementById('play'),
      status: document.getElementById('status'),
      board: document.getElementById('board'),
      lbList: document.getElementById('lbList'),
      resetLb: document.getElementById('resetLb'),
    };

    // Economy in wei (BigInt); ETH = 1e18 wei
    const ETH = 10n ** 18n;
    const MIN_POOL = ETH / 1000n; // 0.001 ETH
    const MAX_POOL = ETH / 10n;   // 0.1   ETH
    let pool = MIN_POOL;

    // Track top spenders (address â†’ total spent in wei)
    const spendMap = new Map();

    function fmtEth(wei) {
      // format to 6 dp without floating errors
      const whole = wei / ETH;
      const frac = ((wei % ETH) * 1_000_000n) / ETH; // 6 dp
      return `${whole}.${frac.toString().padStart(6, '0')}`;
    }
    function feeFromPool(p) { return p / 100n; } // 1%

    function updateEconomyUI() {
      els.poolEth.textContent = fmtEth(pool);
      els.feeEth.textContent = fmtEth(feeFromPool(pool));
    }
    function updateLeaderboardUI() {
      const rows = [...spendMap.entries()]
        .sort((a,b)=> (a[1] < b[1] ? 1 : -1))
        .slice(0,3)
        .map(([addr, wei], i) => {
          const pct = [40,30,20][i] ?? 0;
          return `<li>${addr.slice(0,6)}â€¦${addr.slice(-4)} â€” ${fmtEth(wei)} ETH (eligible ${pct}%)</li>`;
        });
      els.lbList.innerHTML = rows.length ? rows.join('') : '<li>â€”</li><li>â€”</li><li>â€”</li>';
    }
    updateEconomyUI(); updateLeaderboardUI();

    // Wallet connect
    let player = '';
    els.connect.onclick = async () => {
      await provider.request({ method: 'eth_requestAccounts' });
      const accounts = await provider.request({ method: 'eth_accounts' });
      player = accounts[0] || '';
      if (!player) return;
      els.connect.textContent = `âœ… ${player.slice(0,6)}â€¦${player.slice(-4)}`;
      els.connect.style.background = '#4CAF50';
      els.play.disabled = false;
      els.status.innerHTML = 'ğŸ•¶ï¸ <strong>Vato ready!</strong> Pay to play';
    };

    // Tic-tac-toe
    let board = ["","","","","","","","",""];
    let gameActive = false;
    const cells = [...document.querySelectorAll('.cell')];

    cells.forEach(c => c.addEventListener('click', e => {
      if (!gameActive) return;
      const i = +e.currentTarget.dataset.index;
      if (board[i] !== "") return;
      board[i] = "X";
      e.currentTarget.textContent = "X";
      e.currentTarget.classList.add('x');
      if (checkEnd()) return;
      vatoMove();
    }));

    function checkEnd() {
      const W = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      let win = null;
      for (const [a,b,c] of W) if (board[a] && board[a]===board[b] && board[a]===board[c]) { win = board[a]; break; }
      if (win || !board.includes("")) {
        gameActive = false;
        if (win === "X") els.status.innerHTML = "ğŸ‰ <strong>You won!</strong>";
        else if (win === "O") els.status.innerHTML = "ğŸ’€ <strong>Vato smoked you!</strong> Pay to try again";
        else els.status.innerHTML = "ğŸ¤ <strong>Draw</strong>";
        els.play.style.display = "block";
        return true;
      }
      return false;
    }
    function minimax(b, p) {
      const W = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      const opp = p === "X" ? "O" : "X";
      for (const [a,b,c] of W) if (b[a] && b[a]===b[b] && b[a]===b[c]) return { score: b[a]==="O" ? 10 : -10 };
      if (!b.includes("")) return { score: 0 };
      const moves = [];
      for (let i=0;i<9;i++) if (b[i]==="") {
        b[i]=p; const r=minimax(b,opp); moves.push({index:i, score:r.score}); b[i]="";
      }
      if (p==="O") return moves.reduce((m,x)=> x.score>m.score?x:m, moves[0]);
      return moves.reduce((m,x)=> x.score<m.score?x:m, moves[0]);
    }
    function vatoMove() {
      els.status.innerHTML = "ğŸ¤” <strong>Vato thinkingâ€¦</strong>";
      setTimeout(()=>{
        const m = minimax([...board], "O");
        board[m.index]="O";
        const cell = document.querySelector(`.cell[data-index="${m.index}"]`);
        cell.textContent="O"; cell.classList.add('o');
        checkEnd();
      }, 600);
    }
    function resetBoard() {
      board = ["","","","","","","","",""];
      cells.forEach(c=>{ c.textContent=""; c.className="cell"; });
    }

    // Payment + play
    const HOUSE_WALLET = '0xHOUSE_WALLET_PLACEHOLDER'; // TODO: replace
    els.play.onclick = async () => {
      try {
        // Entry fee = 1% of current pool
        const fee = feeFromPool(pool);
        const toHouse = fee / 2n;         // 50% â†’ house
        const toPool  = fee - toHouse;    // 50% â†’ pool (exact split)

        els.status.innerHTML = `â³ <strong>Paying ${fmtEth(fee)} ETHâ€¦</strong>`;

        // One simple transfer to house wallet on Arbitrum
        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [{
            from: player,
            to: HOUSE_WALLET,
            value: '0x' + toHouse.toString(16)
          }]
        });
        // Optional: poll for receipt if you want confirmation UI (omitted for minimalism)

        // Update pool locally
        pool = pool + toPool;
        if (pool > MAX_POOL) pool = MAX_POOL;
        updateEconomyUI();

        // Track spender for leaderboard (demo only)
        const prev = spendMap.get(player) || 0n;
        spendMap.set(player, prev + fee);
        updateLeaderboardUI();

        // Start game
        resetBoard();
        gameActive = true;
        els.board.style.display = "grid";
        els.play.style.display = "none";
        els.status.innerHTML = "ğŸ”« <strong>Your move</strong> (You're X)";

        // Payout trigger (demo message only)
        if (pool >= MAX_POOL) {
          els.status.innerHTML += `<br>ğŸ’° <strong>PAYOUT TRIGGERED</strong> â€” 40/30/20% to top 3 (demo only)`;
          pool = MIN_POOL; updateEconomyUI();
          // spendMap.clear(); updateLeaderboardUI(); // optional reset
        }
      } catch (err) {
        console.error(err);
        els.status.innerHTML = `âŒ <strong>Error:</strong> ${err.message || err}`;
      }
    };

    // Demo leaderboard reset
    els.resetLb.onclick = () => { spendMap.clear(); updateLeaderboardUI(); };
  </script>
</body>
</html>
