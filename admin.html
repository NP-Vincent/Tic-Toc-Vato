<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tic Tac Vato ‚Äî Admin</title>
  <style>
    body { font-family: 'Courier New', monospace; max-width: 420px; margin: 0 auto; padding: 20px; background: #121212; color: #f0f0f0; }
    h1 { color: #FF6B00; text-align: center; font-size: 2rem; margin: 6px 0 16px; }
    .panel { background: #1E1E1E; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #FF6B00; }
    .row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #555; background: #2A2A2A; color: #f0f0f0; }
    button { background: linear-gradient(135deg, #FF6B00 0%, #FF9500 100%); color: #fff; border: 0; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: transform .1s, box-shadow .1s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(255,107,0,.35); }
    button:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color: #bbb; }
  </style>
</head>
<body>
  <h1>Tic Tac Vato ‚Äî Admin</h1>
  <div class="panel">
    <div><strong>Contract:</strong> <span id="contract">‚Äî</span></div>
    <div><strong>Prize Pool:</strong> <span id="pool">‚Äî</span> ETH</div>
    <div><strong>Round:</strong> <span id="round">‚Äî</span></div>
    <div><strong>House Wallet:</strong> <span id="house">‚Äî</span></div>
  </div>

  <div class="panel">
    <div class="row"><button id="connect">üîì Connect Wallet</button></div>
    <div id="status">Loading‚Ä¶</div>
  </div>

  <div class="panel">
    <div><strong>Seed Initial Pool</strong></div>
    <div class="row"><input id="seedAmount" placeholder="ETH" /><button id="seed">Seed</button></div>
  </div>

  <div class="panel">
    <div><strong>Fund Pool</strong></div>
    <div class="row"><input id="fundAmount" placeholder="ETH" /><button id="fund">Fund</button></div>
  </div>

  <div class="panel">
    <div><strong>Set House Wallet</strong></div>
    <div class="row"><input id="newHouse" placeholder="0x‚Ä¶" /><button id="setHouse">Update</button></div>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    import {
      createPublicClient,
      custom,
      encodeFunctionData,
      parseEther,
      waitForTransactionReceipt,
    } from 'https://esm.sh/viem@2.9.32';

    (async () => {
      try {
        sdk.actions.ready().catch(() => {});

        const els = {
          contract: document.getElementById('contract'),
          pool: document.getElementById('pool'),
          round: document.getElementById('round'),
          house: document.getElementById('house'),
          connect: document.getElementById('connect'),
          status: document.getElementById('status'),
          seedAmount: document.getElementById('seedAmount'),
          seed: document.getElementById('seed'),
          fundAmount: document.getElementById('fundAmount'),
          fund: document.getElementById('fund'),
          newHouse: document.getElementById('newHouse'),
          setHouse: document.getElementById('setHouse'),
        };

        let provider, CONTRACT_ADDR, ABI, pub, account;

        try {
          provider = await sdk.wallet.getEthereumProvider();
          const j = await fetch('abi/TicTacVatoPrizePool.json').then(r => r.json());
          CONTRACT_ADDR = j.address;
          ABI = j.abi;
          pub = createPublicClient({ transport: custom(provider) });
          els.contract.textContent = CONTRACT_ADDR;
        } catch (e) {
          console.error(e);
          els.status.textContent = 'Failed to load wallet or contract.';
          return;
        }

        const ARBITRUM_HEX = '0xa4b1';
        async function onCorrectChain() {
          try { return (await provider.request({ method: 'eth_chainId' })) === ARBITRUM_HEX; }
          catch { return false; }
        }

        const ETH = 10n ** 18n;
        const to6 = (wei) => {
          const w = BigInt(wei);
          const whole = w / ETH;
          const frac = ((w % ETH) * 1_000_000n) / ETH;
          return `${whole}.${frac.toString().padStart(6, '0')}`;
        };

        async function refresh() {
          if (!(await onCorrectChain())) {
            els.status.textContent = 'Switch to Arbitrum One (42161).';
            return;
          }
          try {
            const [poolWei, roundId, houseWallet] = await Promise.all([
              pub.readContract({ address: CONTRACT_ADDR, abi: ABI, functionName: 'prizePool' }),
              pub.readContract({ address: CONTRACT_ADDR, abi: ABI, functionName: 'roundId' }),
              pub.readContract({ address: CONTRACT_ADDR, abi: ABI, functionName: 'houseWallet' }),
            ]);
            els.pool.textContent = to6(poolWei);
            els.round.textContent = roundId;
            els.house.textContent = houseWallet;
            els.status.textContent = 'Ready.';
          } catch (err) {
            console.error(err);
            els.status.textContent = 'Read failed.';
          }
        }

        els.connect.onclick = async () => {
          try {
            if (!(await onCorrectChain())) {
              await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: ARBITRUM_HEX }] });
            }
            const accounts = await provider.request({ method: 'eth_requestAccounts' });
            account = accounts?.[0];
            if (!account) throw new Error('No account.');
            els.connect.textContent = `‚úÖ ${account.slice(0,6)}‚Ä¶${account.slice(-4)}`;
            els.connect.style.background = '#4CAF50';
            await refresh();
          } catch (e) {
            console.error(e);
            els.status.textContent = e?.message || 'Wallet connection failed.';
          }
        };

        els.seed.onclick = async () => {
          try {
            if (!account) throw new Error('Connect wallet first.');
            const amt = parseEther(els.seedAmount.value || '0');
            const data = encodeFunctionData({ abi: ABI, functionName: 'seedInitialPool' });
            els.status.textContent = `‚è≥ Seeding ${els.seedAmount.value} ETH‚Ä¶`;
            const hash = await provider.request({
              method: 'eth_sendTransaction',
              params: [{ from: account, to: CONTRACT_ADDR, data, value: '0x' + amt.toString(16) }],
            });
            await waitForTransactionReceipt(pub, { hash });
            els.seedAmount.value = '';
            await refresh();
            els.status.textContent = 'Seeded.';
          } catch (err) {
            console.error(err);
            els.status.textContent = err?.message || 'Seed failed.';
          }
        };

        els.fund.onclick = async () => {
          try {
            if (!account) throw new Error('Connect wallet first.');
            const amt = parseEther(els.fundAmount.value || '0');
            const data = encodeFunctionData({ abi: ABI, functionName: 'fund' });
            els.status.textContent = `‚è≥ Funding ${els.fundAmount.value} ETH‚Ä¶`;
            const hash = await provider.request({
              method: 'eth_sendTransaction',
              params: [{ from: account, to: CONTRACT_ADDR, data, value: '0x' + amt.toString(16) }],
            });
            await waitForTransactionReceipt(pub, { hash });
            els.fundAmount.value = '';
            await refresh();
            els.status.textContent = 'Funded.';
          } catch (err) {
            console.error(err);
            els.status.textContent = err?.message || 'Fund failed.';
          }
        };

        els.setHouse.onclick = async () => {
          try {
            if (!account) throw new Error('Connect wallet first.');
            const addr = els.newHouse.value.trim();
            const data = encodeFunctionData({ abi: ABI, functionName: 'setHouseWallet', args: [addr] });
            els.status.textContent = '‚è≥ Updating house wallet‚Ä¶';
            const hash = await provider.request({
              method: 'eth_sendTransaction',
              params: [{ from: account, to: CONTRACT_ADDR, data }],
            });
            await waitForTransactionReceipt(pub, { hash });
            els.newHouse.value = '';
            await refresh();
            els.status.textContent = 'House wallet updated.';
          } catch (err) {
            console.error(err);
            els.status.textContent = err?.message || 'Update failed.';
          }
        };

        await refresh();
      } finally {
        try { await sdk.actions.ready(); } catch {}
      }
    })();
  </script>
</body>
</html>
