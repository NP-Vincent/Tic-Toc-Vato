<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ•¶ï¸ Tic Tac Vato â€” Minimal</title>

  <!-- Share/launch cards (kept) -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://vato.sqmu.io/assets/og.jpg",
    "button":{
      "title":"Play Tic Tac Vato",
      "action":{
        "type":"launch_frame",
        "name":"Tic Tac Vato",
        "url":"https://vato.sqmu.io/index.html",
        "splashImageUrl":"https://vato.sqmu.io/assets/og.jpg",
        "splashBackgroundColor":"#FF6B00"
      }
    }
  }' />
  <meta name="fc:frame" content='{
    "version":"1",
    "imageUrl":"https://vato.sqmu.io/assets/og.jpg",
    "button":{
      "title":"Play Tic Tac Vato",
      "action":{
        "type":"launch_frame",
        "name":"Tic Tac Vato",
        "url":"https://vato.sqmu.io/index.html",
        "splashImageUrl":"https://vato.sqmu.io/assets/og.jpg",
        "splashBackgroundColor":"#FF6B00"
      }
    }
  }' />

  <style>
    body { font-family: 'Courier New', monospace; max-width: 420px; margin: 0 auto; padding: 20px; background: #121212; color: #f0f0f0; }
    h1 { color: #FF6B00; text-align: center; font-size: 2.2rem; margin: 6px 0 2px; text-shadow: 2px 2px 4px #000; }
    .subtitle { text-align: center; color: #aaa; margin-bottom: 18px; }
    #board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 18px 0; background: #1E1E1E; padding: 10px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,.5); }
    .cell { aspect-ratio: 1; background: #2A2A2A; border: 2px solid #FF6B00; display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; transition: all .2s; }
    .cell:hover { background: #333; transform: scale(1.04); }
    .cell.x { color: #4CAF50; } .cell.o { color: #F44336; }
    #status { font-weight: bold; margin: 12px 0; text-align: center; min-height: 40px; }
    .panel { background: #1E1E1E; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #FF6B00; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    button { background: linear-gradient(135deg, #FF6B00 0%, #FF9500 100%); color: #fff; border: 0; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%; transition: transform .1s, box-shadow .1s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(255,107,0,.35); }
    button:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
    #leaderboard ol { padding-left: 20px; margin: 8px 0 0; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color: #bbb; }
  </style>
</head>
<body>
  <h1>TIC TAC VATO</h1>
  <div class="subtitle">Outwit the Code Cholo</div>

  <div class="panel" id="economy">
    <div class="row"><div>ğŸ¦ Current Prize Pool</div><div><strong><span id="poolEth">0.001000</span> ETH</strong></div></div>
    <div class="row"><div>ğŸŸ Entry Fee (1%)</div><div><strong><span id="feeEth">0.000010</span> ETH</strong></div></div>
    <div class="row"><div>ğŸ“ˆ Target</div><div><strong><span id="targetEth">0.100000</span> ETH</strong></div></div>
    <small class="mono">When the pool hits 0.1 ETH, top 3 spenders win 40%, 30% and 20%. The pool then resets to 0.001 ETH.</small>
  </div>

  <div class="row"><button id="connect">ğŸ”“ Connect Wallet</button></div>
  <div class="row"><button id="play" disabled>ğŸ’¸ Pay & Play</button></div>

  <div id="board" style="display:none;">
    <div class="cell" data-index="0"></div>
    <div class="cell" data-index="1"></div>
    <div class="cell" data-index="2"></div>
    <div class="cell" data-index="3"></div>
    <div class="cell" data-index="4"></div>
    <div class="cell" data-index="5"></div>
    <div class="cell" data-index="6"></div>
    <div class="cell" data-index="7"></div>
    <div class="cell" data-index="8"></div>
  </div>

  <div id="status">ğŸ‘‰ Connect wallet to challenge the vato</div>

  <div class="panel" id="leaderboard">
    <div class="row"><div>ğŸ† Top Spenders</div></div>
    <ol id="lbList"><li>â€”</li><li>â€”</li><li>â€”</li></ol>
  </div>

  <!-- Mini App SDK via ESM CDN -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    import { Interface } from 'https://esm.sh/ethers@6';

    (async () => {
      await sdk.actions.ready(); // allow host to hide splash

      const provider = await sdk.wallet.getEthereumProvider();
      const ARBITRUM_HEX = '0xa4b1';

      // Elements
      const els = {
        poolEth: document.getElementById('poolEth'),
        feeEth: document.getElementById('feeEth'),
        targetEth: document.getElementById('targetEth'),
        connect: document.getElementById('connect'),
        play: document.getElementById('play'),
        status: document.getElementById('status'),
        board: document.getElementById('board'),
        lbList: document.getElementById('lbList')
      };

      // Hard gate: require Arbitrum (no chain switching here)
      const currentChain = await provider.request({ method: 'eth_chainId' });
      if (currentChain !== ARBITRUM_HEX) {
        els.status.textContent = 'This Mini App is only available on Arbitrum One.';
        els.connect.disabled = true;
        els.play.disabled = true;
        return; // stop boot
      }

      // Load prize pool contract ABI + address
      const { abi, address: CONTRACT } = await fetch('abi/TicTacVatoPrizePool.json').then(r => r.json());
      const iface = new Interface(abi);

      // Common utils
      const ETH = 10n ** 18n;
      function fmtEth(wei) {
        const whole = wei / ETH;
        const frac = ((wei % ETH) * 1_000_000n) / ETH;
        return `${whole}.${frac.toString().padStart(6, '0')}`;
      }

      // Read static config
      const cfgData = iface.encodeFunctionData('getConfig');
      const cfgRaw = await provider.request({ method: 'eth_call', params: [{ to: CONTRACT, data: cfgData }, 'latest'] });
      const [MIN_POOL, MAX_POOL] = iface.decodeFunctionResult('getConfig', cfgRaw).map(x => BigInt(x));

      // Dynamic state
      let pool = 0n;
      let fee  = 0n;
      let player = '';

      async function updateEconomyUI() {
        const poolData = iface.encodeFunctionData('prizePool');
        const rawPool = await provider.request({ method: 'eth_call', params: [{ to: CONTRACT, data: poolData }, 'latest'] });
        pool = BigInt(rawPool);

        const feeData = iface.encodeFunctionData('currentFee');
        const rawFee = await provider.request({ method: 'eth_call', params: [{ to: CONTRACT, data: feeData }, 'latest'] });
        fee = BigInt(rawFee);

        els.poolEth.textContent = fmtEth(pool);
        els.feeEth.textContent = fmtEth(fee);
        els.targetEth.textContent = fmtEth(MAX_POOL);
      }

      async function updateLeaderboardUI() {
        const lbData = iface.encodeFunctionData('getLeaderboard');
        const raw = await provider.request({ method: 'eth_call', params: [{ to: CONTRACT, data: lbData }, 'latest'] });
        const [addrs, amts] = iface.decodeFunctionResult('getLeaderboard', raw);

        const rows = addrs.map((addr, i) => ({ addr, amt: BigInt(amts[i]) }))
          .filter(x => x.addr !== '0x0000000000000000000000000000000000000000' && x.amt > 0n)
          .map((x, i) => {
            const pct = [40,30,20][i] ?? 0;
            return `<li>${x.addr.slice(0,6)}â€¦${x.addr.slice(-4)} â€” ${fmtEth(x.amt)} ETH (eligible ${pct}%)</li>`;
          });

        els.lbList.innerHTML = rows.length ? rows.join('') : '<li>â€”</li><li>â€”</li><li>â€”</li>';
      }

      await updateEconomyUI();
      await updateLeaderboardUI();

      // Connect flow (user gesture)
      els.connect.onclick = async () => {
        try {
          await provider.request({ method: 'eth_requestAccounts' });
          const accounts = await provider.request({ method: 'eth_accounts' });
          player = accounts?.[0] ?? '';
          if (!player) {
            els.status.textContent = 'Wallet not connected.';
            els.play.disabled = true;
            return;
          }
          els.connect.textContent = `âœ… ${player.slice(0,6)}â€¦${player.slice(-4)}`;
          els.connect.style.background = '#4CAF50';
          els.play.disabled = false;
          els.status.innerHTML = 'ğŸ•¶ï¸ <strong>Vato ready!</strong> Pay to play';
        } catch {
          els.status.textContent = 'Connection was cancelled or failed.';
        }
      };

      // React to provider changes
      provider.on?.('accountsChanged', (accs) => {
        const a0 = accs?.[0];
        if (!a0) {
          player = '';
          els.connect.textContent = 'ğŸ”“ Connect Wallet';
          els.connect.style.background = '';
          els.play.disabled = true;
          els.status.textContent = 'ğŸ‘‰ Connect wallet to challenge the vato';
          return;
        }
        player = a0;
        els.connect.textContent = `âœ… ${a0.slice(0,6)}â€¦${a0.slice(-4)}`;
        els.connect.style.background = '#4CAF50';
        // keep play enabled when on correct chain
        els.play.disabled = false;
      });

      provider.on?.('chainChanged', (cid) => {
        if (cid !== ARBITRUM_HEX) {
          els.play.disabled = true;
          els.connect.disabled = true;
          els.status.textContent = 'This Mini App is only available on Arbitrum One.';
        } else {
          els.connect.disabled = false;
          if (player) els.play.disabled = false;
        }
      });

      // --- Game logic (unchanged) ---
      let board = ["","","","","","","","",""];
      let gameActive = false;
      const cells = [...document.querySelectorAll('.cell')];

      cells.forEach(c => c.addEventListener('click', e => {
        if (!gameActive) return;
        const i = +e.currentTarget.dataset.index;
        if (board[i] !== "") return;
        board[i] = "X";
        e.currentTarget.textContent = "X";
        e.currentTarget.classList.add('x');
        if (checkEnd()) return;
        vatoMove();
      }));

      function checkEnd() {
        const W = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        let win = null;
        for (const [a,b,c] of W) if (board[a] && board[a]===board[b] && board[a]===board[c]) { win = board[a]; break; }
        if (win || !board.includes("")) {
          gameActive = false;
          if (win === "X") els.status.innerHTML = "ğŸ‰ <strong>You won!</strong>";
          else if (win === "O") els.status.innerHTML = "ğŸ’€ <strong>Vato smoked you!</strong> Pay to try again";
          else els.status.innerHTML = "ğŸ¤ <strong>Draw</strong>";
          els.play.style.display = "block";
          return true;
        }
        return false;
      }

      function minimax(b, playerMark) {
        const W = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        const opp = playerMark === "X" ? "O" : "X";
        for (const [i, j, k] of W)
          if (b[i] && b[i] === b[j] && b[i] === b[k])
            return { score: b[i] === "O" ? 10 : -10 };
        if (!b.includes("")) return { score: 0 };
        const moves = [];
        for (let idx = 0; idx < 9; idx++) if (b[idx] === "") {
          b[idx] = playerMark;
          const result = minimax(b, opp);
          moves.push({ index: idx, score: result.score });
          b[idx] = "";
        }
        return (playerMark === "O")
          ? moves.reduce((best, x) => x.score > best.score ? x : best, moves[0])
          : moves.reduce((best, x) => x.score < best.score ? x : best, moves[0]);
      }

      function vatoMove() {
        els.status.innerHTML = "ğŸ¤” <strong>Vato thinkingâ€¦</strong>";
        setTimeout(()=>{
          const m = minimax([...board], "O");
          board[m.index] = "O";
          const cell = document.querySelector(`.cell[data-index="${m.index}"]`);
          cell.textContent = "O"; cell.classList.add('o');
          checkEnd();
        }, 600);
      }

      function resetBoard() {
        board = ["","","","","","","","",""];
        cells.forEach(c=>{ c.textContent=""; c.className="cell"; });
      }

      // Payment + play
      els.play.onclick = async () => {
        try {
          await updateEconomyUI();
          els.status.innerHTML = `â³ <strong>Paying ${fmtEth(fee)} ETHâ€¦</strong>`;

          const data = iface.encodeFunctionData('play');
          const txHash = await provider.request({
            method: 'eth_sendTransaction',
            params: [{
              from: player,
              to: CONTRACT,
              data,
              value: '0x' + fee.toString(16)
            }]
          });

          // Optionally wait/verify tx here with eth_getTransactionReceipt

          await updateEconomyUI();
          await updateLeaderboardUI();

          resetBoard();
          gameActive = true;
          els.board.style.display = "grid";
          els.play.style.display = "none";
          els.status.innerHTML = "ğŸ”« <strong>Your move</strong> (You're X)";
        } catch (err) {
          console.error(err);
          els.status.innerHTML = `âŒ <strong>Error:</strong> ${err?.message ?? err}`;
        }
      };
    })();
  </script>
</body>
</html>
